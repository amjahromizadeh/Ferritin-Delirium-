---
title: "Mendelian randomization, SMR/HEIDI, and colocalisation report: Serum ferritin and delirium risk"
subtitle: "Serum ferritin and delirium risk: Integrative genomic analysis identifies locus-specific signals at 19q13 with no genome-wide causal effect"
author: "Nafiseh"
date: "2025-12-20"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    number_sections: true
    code_folding: hide
    df_print: paged
    theme: flatly
    self_contained: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE, message = FALSE, warning = FALSE,
  fig.align = "center", fig.width = 7.5, fig.height = 4.8
)

suppressPackageStartupMessages({
  library(dplyr)
  library(tidyr)
  library(data.table)
  library(ggplot2)
  library(knitr)
  library(kableExtra)
  library(stringr)
})

# ---------------------------
# Colour system (your palette)
# ---------------------------
COL <- list(
  ceil     = "#999ECF",
  platinum = "#EDDDEC",
  liberty  = "#60509D",
  blue     = "#3E389E",
  grape    = "#5D1451",
  lilac    = "#adbae3",
  butter   = "#FFEDA8",
  pancake  = "#D99058",
  rose     = "#E5C8CD",
  pine     = "#1D6C5C"
)

# Accent assignment (consistent throughout report)
COL_FERRITIN <- COL$blue
COL_DELIRIUM <- COL$pine
COL_NEUTRAL  <- "#333333"

# ---------------------------
# Paths (GitHub Pages-friendly)
# Assumes this Rmd lives in docs/
# ---------------------------
DOCS_DIR <- if (basename(getwd()) == "docs") getwd() else file.path(getwd(), "docs")
FIG_DIR  <- file.path(DOCS_DIR, "figures")
DATA_DIR <- file.path(DOCS_DIR, "data")
dir.create(FIG_DIR,  showWarnings = FALSE, recursive = TRUE)
dir.create(DATA_DIR, showWarnings = FALSE, recursive = TRUE)

# ---------------------------
# Helpers
# ---------------------------
fmt_p <- function(p) {
  ifelse(is.na(p), NA_character_,
         ifelse(p < 1e-3, format(p, scientific = TRUE, digits = 2), formatC(p, digits = 3, format = "f")))
}
fmt_num <- function(x, d = 3) ifelse(is.na(x), NA_character_, formatC(x, digits = d, format = "f"))
fmt_e   <- function(x, d = 2) ifelse(is.na(x), NA_character_, format(x, scientific = TRUE, digits = d))

or_ci <- function(beta, se){
  OR  <- exp(beta)
  LCI <- exp(beta - 1.96 * se)
  UCI <- exp(beta + 1.96 * se)
  c(OR = OR, LCI = LCI, UCI = UCI)
}

kbl_nice <- function(df, caption = NULL){
  kable(df, format = "html", caption = caption, escape = FALSE) |>
    kable_styling(full_width = FALSE,
                  bootstrap_options = c("striped", "hover", "condensed")) |>
    row_spec(0, background = COL$platinum, color = COL$grape) |>
    scroll_box(width = "100%", height = "320px")
}

# Tooltip bubble (CSS hover). Usage: tip("definition text")
tip <- function(def){
  sprintf('<span class="help">?<span class="helptext">%s</span></span>', def)
}


dl_btn <- function(label, href){
  sprintf('<a class="dl-btn" href="%s" download>%s</a>', href, label)
}

```

<style> :root{ --ceil: #999ECF; --platinum: #EDDDEC; --liberty: #60509D; --blue: #3E389E; --grape: #5D1451; --lilac: #adbae3; --butter: #FFEDA8; --pancake: #D99058; --rose: #E5C8CD; --pine: #1D6C5C; } h1, h2, h3 { color: var(--grape); } h2 { margin-top: 1.2em; border-bottom: 2px solid var(--platinum); padding-bottom: 0.25em; } h3 { margin-top: 1.0em; } .callout { background: var(--platinum); border-left: 6px solid var(--blue); padding: 12px 14px; border-radius: 14px; margin: 10px 0 16px 0; } .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(210px, 1fr)); gap: 10px; margin: 10px 0 16px 0; } .cardx{ background: white; border: 1px solid var(--platinum); border-radius: 16px; padding: 10px 12px; box-shadow: 0 6px 18px rgba(0,0,0,0.04); } .cardx .k { color: #555; font-size: 0.88em; } .cardx .v { color: var(--grape); font-size: 1.25em; font-weight: 700; } .badge{ display:inline-block; padding: 2px 10px; border-radius: 999px; font-size: 0.85em; font-weight: 600; background: var(--butter); color: #3a2d00; border: 1px solid rgba(0,0,0,0.06); } details{ background: white; border: 1px solid var(--platinum); border-radius: 16px; padding: 10px 12px; margin: 12px 0 16px 0; } summary{ cursor: pointer; font-weight: 700; color: var(--blue); } summary:hover{ color: var(--liberty); } .dl-btn{ display: inline-block; padding: 8px 12px; border-radius: 999px; background: var(--blue); color: white !important; text-decoration: none !important; font-weight: 700; font-size: 0.90em; margin: 6px 8px 6px 0; } .dl-btn:hover{ background: var(--liberty); } .help{ position: relative; display: inline-block; width: 18px; height: 18px; line-height: 18px; text-align: center; border-radius: 999px; background: var(--lilac); color: var(--grape); font-weight: 800; font-size: 0.85em; margin-left: 6px; vertical-align: text-top; } .helptext{ visibility: hidden; opacity: 0; width: 320px; background: var(--platinum); color: #1f1f1f; border: 1px solid var(--ceil); border-radius: 14px; padding: 10px 12px; position: absolute; z-index: 999; top: 24px; left: -140px; box-shadow: 0 8px 22px rgba(0,0,0,0.08); transition: opacity 0.15s ease-in-out; } .help:hover .helptext{ visibility: visible; opacity: 1; } .figcap{ margin-top: 6px; font-size: 0.95em; color: #444; background: #fafafa; border: 1px solid var(--platinum); border-radius: 14px; padding: 10px 12px; } .figcap b{ color: var(--grape); } </style>
  
## Authors List:

 1.  Amirhossein Saed
 2.  Mahdi Akbarzadeh
 3.  Fatemeh Gohari
 4.  Nafiseh Asadrouh
 5.  Amir Mohammad Jahromizadeh
 6.  Hani Sabaie
 7.  Maryam Zarkesh
 8.  Mehdi Hedayati
 9.  Fereidoun Azizi
 10. Maryam Sadat Daneshpour

## Data and preprocessing

### Introduction

Exposure: Ferritin \| GWAS summary statistics: [GWAS catalogue](https://www.ebi.ac.uk/gwas/studies/GCST90270865) \| Reference paper: [Butler-Laporte G et al.2023](https://pubmed.ncbi.nlm.nih.gov/36773317/)

-   Sample size: 270,794

-   Ancestry: European

Outcome: Delirium \| GWAS summary statistics: [GWAS catalogue](https://www.ebi.ac.uk/gwas/studies/GCST90473243) \| Reference paper: [UK Biobank Whole-Genome Sequencing Consortium](https://www.ebi.ac.uk/gwas/studies/GCST90473243)

-   Sample size: 458,440

-   Ancestry: European

### Data Prepration

**Ferritin GWAS:**

-   Number of total SNPs in the raw exposure file: 10,251,641
-   Number of total SNPs in the harmonized exposure file: 10,218,238
-   Number of total SNPs with invalid rsID: 0
-   Number of total SNPs with invalid alleles: 0
-   Number of total SNPs with 0.42 \< MAF \< 0.58: 0
-   Number of total SNPs with non-numeric se/b/p: 0

**Delirium GWAS:**

-   Number of total SNPs in the raw exposure file: 96,468,105
-   Number of total SNPs in the harmonized exposure file: 84,399,074
-   Number of total SNPs with invalid rsID: 0
-   Number of total SNPs with invalid alleles: 7,725,089
-   Number of total SNPs with 0.42 \< MAF \< 0.58: 67,065,071
-   Number of total SNPs with non-numeric se/b/p: 0

------------------------------------------------------------------------

## Integrated results across MR, SMR/HEIDI, and colocalisation {.tabset .tabset-fade}

### **Two-sample MR** 

```{r tab1_mr_objects}
# ============================================================
# Tab 1 — Two-sample MR
# Values sourced from your MR log (TwoSampleMR + MR-PRESSO) and scripts.
# ============================================================

mean_F <- 78.76

# --- Main MR estimates (TwoSampleMR)
mr_main <- tibble::tribble(
  ~method, ~nsnp, ~beta, ~se, ~pval,
  "IVW (multiplicative random effects)", 70L, 0.0822032, 0.0764773, 0.2824330,
  "MR-Egger",                            70L, 0.1617036, 0.1414843, 0.2570848,
  "Weighted median",                     70L, 0.0898712, 0.0974262, 0.3562921
) |>
  rowwise() |>
  mutate(
    OR  = or_ci(beta, se)["OR"],
    LCI = or_ci(beta, se)["LCI"],
    UCI = or_ci(beta, se)["UCI"]
  ) |>
  ungroup()

# --- Heterogeneity (Cochran's Q)
het <- tibble::tribble(
  ~method, ~Q, ~Q_df, ~Q_pval,
  "IVW",      96.99547, 69L, 0.0147892,
  "MR-Egger", 96.36125, 68L, 0.0134358
)

# --- MR-Egger intercept (directional pleiotropy)
pleio <- tibble::tibble(
  egger_intercept = -0.0034819,
  se = 0.0052046,
  pval = 0.5057626
)

# --- Steiger directionality
steiger <- tibble::tibble(
  snp_r2_exposure = 0.0206426,
  snp_r2_outcome  = 0.0002185,
  correct_causal_direction = TRUE,
  steiger_pval = 0
)

# --- MR-PRESSO summary
presso <- tibble::tribble(
  ~analysis, ~beta, ~se, ~pval,
  "Raw",               0.0878940, 0.0762235, 0.2527882,
  "Outlier-corrected", 0.1198282, 0.0585500, 0.0445093
) |>
  rowwise() |>
  mutate(
    OR  = or_ci(beta, se)["OR"],
    LCI = or_ci(beta, se)["LCI"],
    UCI = or_ci(beta, se)["UCI"]
  ) |>
  ungroup()

presso_global_p    <- 0.017
presso_distort_p   <- 0.705
presso_outlier_n   <- 1L  # from your narrative: a single flagged index downstream

# --- Export tidy TSVs to docs/data/ for download buttons
fwrite(as.data.table(mr_main), file.path(DATA_DIR, "tab1_mr_main.tsv"), sep = "\t")
fwrite(as.data.table(het),     file.path(DATA_DIR, "tab1_mr_heterogeneity.tsv"), sep = "\t")
fwrite(as.data.table(pleio),   file.path(DATA_DIR, "tab1_mr_pleiotropy.tsv"), sep = "\t")
fwrite(as.data.table(steiger), file.path(DATA_DIR, "tab1_mr_steiger.tsv"), sep = "\t")
fwrite(as.data.table(presso),  file.path(DATA_DIR, "tab1_mr_presso.tsv"), sep = "\t")

```

```{r tab1_mr_header, results="asis"}
ivw <- mr_main |> dplyr::filter(method == "IVW (multiplicative random effects)") |> dplyr::slice(1)

cat(sprintf('
<div class="callout">
<b>Integrated MR interpretation.</b>
The primary IVW (random-effects) estimate is <b>non-significant</b>
(OR = %.3f, 95%% CI %.3f–%.3f; p = %s).
There is evidence of heterogeneity (IVW Cochran’s Q p = %s), but no evidence of <i>directional</i> pleiotropy (MR-Egger intercept p = %s).
Steiger filtering supports the direction Ferritin → Delirium (R²<sub>x</sub> > R²<sub>y</sub>; p = %s).
MR-PRESSO detects outliers (global p = %s), but the distortion test is non-significant (p = %s), so the outlier-corrected nominal association should be treated as <b>exploratory</b>.
</div>',
  ivw$OR, ivw$LCI, ivw$UCI, fmt_p(ivw$pval),
  fmt_p(het |> dplyr::filter(method=="IVW") |> dplyr::pull(Q_pval)),
  fmt_p(pleio$pval),
  fmt_p(steiger$steiger_pval),
  fmt_p(presso_global_p),
  fmt_p(presso_distort_p)
))

cat('<div class="cards">')
cat(sprintf('<div class="cardx"><div class="k">Instruments</div><div class="v">%d SNPs</div><span class="badge">Ferritin → Delirium</span></div>',
            ivw$nsnp))
cat(sprintf('<div class="cardx"><div class="k">Instrument strength %s</div><div class="v">%s</div><div class="k">Mean F-statistic</div></div>',
            tip("F-statistic gauges instrument strength; a common rule-of-thumb is F ≥ 10. Mean F = 78.76 indicates strong instruments and low risk of weak-IV bias."),
            fmt_num(mean_F,2)))
cat(sprintf('<div class="cardx"><div class="k">Heterogeneity %s</div><div class="v">Q p = %s</div><div class="k">Cochran’s Q (IVW)</div></div>',
            tip("Cochran’s Q tests whether per-SNP ratio estimates vary more than expected by chance; significant Q suggests heterogeneity (often pleiotropy or multiple mechanisms)."),
            fmt_p(het |> dplyr::filter(method=="IVW") |> dplyr::pull(Q_pval))))
cat(sprintf('<div class="cardx"><div class="k">Directional pleiotropy %s</div><div class="v">p = %s</div><div class="k">MR-Egger intercept</div></div>',
            tip("MR-Egger intercept tests unbalanced (directional) horizontal pleiotropy; non-significant intercept suggests no consistent directional bias."),
            fmt_p(pleio$pval)))
cat(sprintf('<div class="cardx"><div class="k">Directionality %s</div><div class="v">%s</div><div class="k">Steiger p = %s</div></div>',
            tip("Steiger compares variance explained in exposure vs outcome; if R²_exposure > R²_outcome, Ferritin → Delirium is supported over reverse."),
            ifelse(steiger$correct_causal_direction, "Supported", "Uncertain"),
            fmt_p(steiger$steiger_pval)))
cat(sprintf('<div class="cardx"><div class="k">Outliers %s</div><div class="v">%d</div><div class="k">Global p = %s; Distortion p = %s</div></div>',
            tip("MR-PRESSO tests for outlier instruments (global test) and whether removing them significantly changes the estimate (distortion test)."),
            presso_outlier_n, fmt_p(presso_global_p), fmt_p(presso_distort_p)))
cat('</div>')

```
```{r tab1_mr_tables, results="asis"}
# Table MR-1: main (and robust) estimators
mr_tbl <- mr_main |>
  dplyr::transmute(
    Method = method,
    `N SNPs` = nsnp,
    `β (log OR)` = fmt_num(beta, 4),
    `SE` = fmt_num(se, 4),
    `OR (95% CI)` = sprintf("%.3f (%.3f–%.3f)", OR, LCI, UCI),
    `p` = fmt_p(pval)
  )

cat(dl_btn("Download: MR main table", "data/tab1_mr_main.tsv"))
cat(kbl_nice(mr_tbl, caption = "Table MR-1. Two-sample MR estimates for ferritin → delirium across estimators."))

# Table MR-2: diagnostics “scoreboard”
diag_tbl <- tibble::tibble(
  Test = c(
    paste0("Instrument strength ", tip("Mean F-statistic summarises strength; a common heuristic is F ≥ 10.")),
    paste0("Heterogeneity (IVW) ", tip("Cochran’s Q p-value tests whether ratio estimates are heterogeneous.")),
    paste0("Directional pleiotropy ", tip("MR-Egger intercept p-value tests directional pleiotropy.")),
    paste0("Directionality (Steiger) ", tip("Steiger supports Ferritin → Delirium if R²_exposure > R²_outcome.")),
    paste0("Outliers (MR-PRESSO) ", tip("Global test detects outliers; distortion test asks if estimate changes materially after removal.")),
    "MR-PRESSO outlier-corrected estimate"
  ),
  Result = c(
    sprintf("Mean F = %s", fmt_num(mean_F,2)),
    sprintf("Q = %s (df=%d), p = %s",
            fmt_num(het$Q[het$method=="IVW"],2), het$Q_df[het$method=="IVW"], fmt_p(het$Q_pval[het$method=="IVW"])),
    sprintf("Intercept = %s (SE=%s), p = %s",
            fmt_num(pleio$egger_intercept,4), fmt_num(pleio$se,4), fmt_p(pleio$pval)),
    sprintf("R²x = %s; R²y = %s; direction = %s; p = %s",
            fmt_num(steiger$snp_r2_exposure,6), fmt_num(steiger$snp_r2_outcome,6),
            ifelse(steiger$correct_causal_direction, "Ferritin → Delirium", "Reverse/uncertain"),
            fmt_p(steiger$steiger_pval)),
    sprintf("Global p = %s; Distortion p = %s; outliers = %d",
            fmt_p(presso_global_p), fmt_p(presso_distort_p), presso_outlier_n),
    {
      pc <- presso |> dplyr::filter(analysis=="Outlier-corrected") |> dplyr::slice(1)
      sprintf("β = %s (SE=%s), OR = %.3f (%.3f–%.3f), p = %s",
              fmt_num(pc$beta,4), fmt_num(pc$se,4), pc$OR, pc$LCI, pc$UCI, fmt_p(pc$pval))
    }
  )
)

cat(dl_btn("Download: MR heterogeneity", "data/tab1_mr_heterogeneity.tsv"))
cat(dl_btn("Download: MR pleiotropy", "data/tab1_mr_pleiotropy.tsv"))
cat(dl_btn("Download: MR Steiger", "data/tab1_mr_steiger.tsv"))
cat(dl_btn("Download: MR-PRESSO", "data/tab1_mr_presso.tsv"))

cat(kbl_nice(diag_tbl, caption = "Table MR-2. Diagnostic summary for strength, heterogeneity, pleiotropy, directionality, and outliers."))
```


```{r tab1_forest_plot}
# Forest plot uses the exact values in mr_main + MR-PRESSO outlier-corrected
forest_df <- dplyr::bind_rows(
  mr_main |> dplyr::select(method, beta, se),
  presso  |> dplyr::filter(analysis=="Outlier-corrected") |>
    dplyr::transmute(method="IVW (MR-PRESSO outlier-corrected)", beta=beta, se=se)
) |>
  dplyr::rowwise() |>
  dplyr::mutate(
    OR  = as.numeric(or_ci(beta, se)["OR"]),
    LCI = as.numeric(or_ci(beta, se)["LCI"]),
    UCI = as.numeric(or_ci(beta, se)["UCI"])
  ) |>
  dplyr::ungroup() |>
  dplyr::mutate(
    method = factor(method, levels = c(
      "Weighted median",
      "MR-Egger",
      "IVW (MR-PRESSO outlier-corrected)",
      "IVW (multiplicative random effects)"
    ))
  )

p_forest <- ggplot(forest_df, aes(x = OR, y = method)) +
  geom_vline(xintercept = 1, linetype = "dashed", colour = COL$ceil, linewidth = 0.9) +
  geom_errorbarh(aes(xmin = LCI, xmax = UCI), height = 0.16, colour = COL_FERRITIN, linewidth = 1.0) +
  geom_point(size = 2.8, colour = COL$grape) +
  labs(
    x = "Odds ratio (per SD higher ferritin)",
    y = NULL,
    title = "Figure MR1. Causal estimates across MR estimators"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    panel.grid.minor = element_blank(),
    panel.grid.major.y = element_blank()
  )

p_forest
ggsave(file.path(FIG_DIR, "Figure_MR1_forest_theme.png"), p_forest,
       width = 7.8, height = 4.2, dpi = 320, bg = "white")

```

<details>
<summary>Diagnostics (MR)</summary>

```{r tab1_diag_images, results="asis"}

render_fig <- function(title, filename, caption){
  fp <- file.path(FIG_DIR, filename)
  if (!file.exists(fp)) {
    cat(sprintf(
      "<p><b>Missing figure:</b> <code>%s</code><br/>Expected at: <code>%s</code></p>",
      filename, fp
    ))
    return(invisible(FALSE))
  }

  # Use repo-relative path for HTML (works on GitHub Pages)
  src <- sprintf("figures/%s", filename)

  cat(sprintf("<h4>%s</h4>", title))
  cat(sprintf(
    "<img src='%s' style='width:100%%; border-radius:16px; border:1px solid %s;'/>",
    src, COL$platinum
  ))
  cat(sprintf(
    "<div class='figcap'><b>Interpretive caption.</b> %s</div>",
    caption
  ))

  invisible(TRUE)
}

# --- Your exact filenames (including .png) ---
fn_scatter <- "MR scatter plot (per-SNP effects).png"
fn_funnel  <- "Funnel plot (per-SNP ratio estimates).png"
fn_loo     <- "Leave-one-out influence plot.png"
fn_presso  <- "MR-PRESSO outlier map.png"

render_fig(
  "Supplementary Figure S-MR1. MR scatter plot",
  fn_scatter,
  "Scatter of per-SNP effects (ferritin vs delirium) with estimator lines; approximate alignment of slopes supports method-level consistency in direction."
)

render_fig(
  "Supplementary Figure S-MR2. Funnel plot",
  fn_funnel,
  "Funnel symmetry provides a qualitative screen for outlier/asymmetry patterns that can reflect pleiotropy or influential instruments."
)

render_fig(
  "Supplementary Figure S-MR3. Leave-one-out influence plot",
  fn_loo,
  "Stability of the IVW estimate under leave-one-out suggests the inference is not driven by a single SNP; large shifts would indicate sensitivity to specific instruments."
)

render_fig(
  "Supplementary Figure S-MR4. MR-PRESSO outlier map",
  fn_presso,
  "MR-PRESSO outlier map visualises instruments flagged as outliers; interpretation should be paired with the global outlier test and the distortion test."
)

```


</details> 

### **SMR/HEIDI**





### **Colocalisation** 



